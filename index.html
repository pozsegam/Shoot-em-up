<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <script src="node_modules/pixi.js/dist/browser/pixi.js"></script>
    <script src="node_modules/@pixi/sound/dist/pixi-sound.js"></script>

</head>
<body>
    <script>
        let background,spaceShip, state;

        let app = new PIXI.Application({ width: 800, height: 600 });
        document.body.appendChild(app.view);
        
        PIXI.Loader.shared
            .add("assets/spaceShip.png")
            .add("assets/background.png")
            .add("assets/fire.gif")
            .add("assets/bullet.png")
            .add("assets/enemy.png")
            .load(setup);
            
        function setup() {
                // engine sound
                const sound = PIXI.sound.Sound.from({
                url:"assets/music.mp3",
                // autoPlay: true,
                volume: 0.2,
                })

                //bg image
            background = new PIXI.TilingSprite(
                PIXI.Loader.shared.resources["assets/background.png"].texture, 800, 600,
            );
            let fire = new PIXI.Sprite(
                    PIXI.Loader.shared.resources["assets/fire.gif"].texture
                );    

                spaceShip = new PIXI.Sprite(
                    PIXI.Loader.shared.resources["assets/spaceShip.png"].texture
                );   
            //spaceship position
            spaceShip.position.set(20,100);
            //velocity
            spaceShip.vx =0;
            spaceShip.vy =0;
            //spaceship scale
            spaceShip.width = 60;
            spaceShip.height = 60;
            

            fire.width = 90;
            fire.height = 90;
            fire.position.set(-90,145)
                
            spaceShip.addChild(fire)
            app.stage.addChild(background)
            app.stage.addChild(spaceShip);
                
            state = play;
            
            setInterval(addEnemy,2000)
            

            app.ticker.add((delta) => gameLoop(delta))
        }

        document.addEventListener('keydown', keyDownHandler);
        document.addEventListener('keyup', keyUpHandler);

        function keyDownHandler(event){
            switch(event.keyCode){
                case 39:
                    spaceShip.vx =5;

                break;

                case 37:
                    spaceShip.vx =-5;
                break;
                case 40:
                    spaceShip.vy = 5;
                break;
                case 38:
                    spaceShip.vy = -5;
                break;
                case 32:
                    shoot();
                break;
            }
        }
        function keyUpHandler(event){
            switch(event.keyCode){
                case 39:
                    spaceShip.vx =0;
                break;
                case 37:
                    spaceShip.vx =0;
                break;
                case 40:
                    spaceShip.vy =0;
                break;
                case 38:
                    spaceShip.vy =0;
                break;
            }


        }

        function contain(sprite, container) {

            let collision = undefined;

            //Left
            if (sprite.x < container.x) {
            sprite.x = container.x;
            collision = "left";
            }

            //Top
            if (sprite.y < container.y) {
            sprite.y = container.y;
            collision = "top";
            }

            //Right
            if (sprite.x + sprite.width > container.width) {
            sprite.x = container.width - sprite.width;
            collision = "right";
            }

            //Bottom
            if (sprite.y + sprite.height > container.height) {
            sprite.y = container.height - sprite.height;
            collision = "bottom";
            }

            //Return the `collision` value
            return collision;
        }


    
        let ammo = [];
        
        function shoot(e){
        
            let bullet = new PIXI.Sprite(
                    PIXI.Loader.shared.resources["assets/bullet.png"].texture
            );  
            let startY = spaceShip.y + (spaceShip.height/4)
            let startX = spaceShip.x +30;
            bullet.position.set(startX, startY)
            app.stage.addChild(bullet)

            ammo.push(bullet)
            
        }

        function randomInt(min,max){
            return Math.floor(Math.random() * (max - min + 1) + min)
        }

        let enemies = []

       function addEnemy(){     
            console.log("call")       
            let enemy = new PIXI.Sprite(
                    PIXI.Loader.shared.resources["assets/enemy.png"].texture
            );
            enemy.width = 60
            enemy.height = 60
            enemy.position.set(randomInt(800,900)-enemy.width,randomInt(1,600)-enemy.height)
            app.stage.addChild(enemy)
            enemies.push(enemy)
            console.log(enemies)
        }
        
        function gameLoop(delta) {
            state(delta)
        }

        
        function play(delta){
                contain(spaceShip, {x:0, y:0, width:800, height:600});
                spaceShip.x  += spaceShip.vx;
                spaceShip.y  += spaceShip.vy;   


                for(let i=0; i<ammo.length;i++){
                    if(hitTestRectangle(ammo[i],enemies)){
                        console.log("pew")
                    }
                    ammo[i].x +=5;
                    
                }

                for(let i=0; i<enemies.length;i++){
                    if(hitTestRectangle(enemies[i],spaceShip)){
                        console.log("pew")
                   }
                    enemies[i].x -=2;

                }
    

                background.tilePosition.x-=1;
        }

    
        
        function hitTestRectangle(r1, r2) {

//Calculate `centerX` and `centerY` properties on the sprites
r1.centerX = r1.x + r1.width / 2;
r1.centerY = r1.y + r1.height / 2;
r2.centerX = r2.x + r2.width / 2;
r2.centerY = r2.y + r2.height / 2;

//Calculate the `halfWidth` and `halfHeight` properties of the sprites
r1.halfWidth = r1.width / 2;
r1.halfHeight = r1.height / 2;
r2.halfWidth = r2.width / 2;
r2.halfHeight = r2.height / 2;

//Create a `collision` variable that will tell us
//if a collision is occurring
let collision = false;

//Check whether the shapes of the sprites are overlapping. If they
//are, set `collision` to `true`
if (Math.abs(r1.centerX - r2.centerX) < r1.halfWidth + r2.halfWidth
&& Math.abs(r1.centerY - r2.centerY) < r1.halfHeight + r2.halfHeight) {
  collision = true;
}

//Return the value of `collision` back to the main program
return collision;
}
      </script>
</body>
</html>